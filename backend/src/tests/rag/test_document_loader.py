import sys
import os
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ src –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', '..'))

from ml.rag_bot import DocumentLoader, Document

print("üìÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º DocumentLoader...")

# –°–æ–∑–¥–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
loader = DocumentLoader()

# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
test_dir = Path("./data/test_documents")
test_dir.mkdir(parents=True, exist_ok=True)

# 1. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π TXT —Ñ–∞–π–ª
txt_file = test_dir / "test.txt"
with open(txt_file, 'w', encoding='utf-8') as f:
    f.write("–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç.\n–í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç–µ–∫—Å—Ç–∞.\n–¢—Ä–µ—Ç—å—è —Å—Ç—Ä–æ–∫–∞ —Å —Ä—É—Å—Å–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º.")

print("‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π TXT —Ñ–∞–π–ª")

# 2. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π MD —Ñ–∞–π–ª
md_file = test_dir / "test.md"
with open(md_file, 'w', encoding='utf-8') as f:
    f.write("# –ó–∞–≥–æ–ª–æ–≤–æ–∫\n\n–≠—Ç–æ **markdown** –¥–æ–∫—É–º–µ–Ω—Ç —Å *—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º*.\n\n## –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫\n\n–°–ø–∏—Å–æ–∫:\n- –ü—É–Ω–∫—Ç 1\n- –ü—É–Ω–∫—Ç 2")

print("‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π MD —Ñ–∞–π–ª")

# 3. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π Python —Ñ–∞–π–ª
py_file = test_dir / "test.py"
with open(py_file, 'w', encoding='utf-8') as f:
    f.write('def hello():\n    """–¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""\n    print("–ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!")\n\nif __name__ == "__main__":\n    hello()')

print("‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π PY —Ñ–∞–π–ª")

print("\nüîç –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤...")

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É TXT —Ñ–∞–π–ª–∞
try:
    doc_txt = loader.load_file(str(txt_file))
    print(f"üìÑ TXT —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω:")
    print(f"   –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {len(doc_txt.content)} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"   –ò–º—è —Ñ–∞–π–ª–∞: {doc_txt.metadata['filename']}")
    print(f"   –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ: {doc_txt.metadata['file_extension']}")
    print(f"   –ü–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤: {doc_txt.content[:50]}...")
except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ TXT: {e}")

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É MD —Ñ–∞–π–ª–∞
try:
    doc_md = loader.load_file(str(md_file))
    print(f"üìÑ MD —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω:")
    print(f"   –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {len(doc_md.content)} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"   –ò–º—è —Ñ–∞–π–ª–∞: {doc_md.metadata['filename']}")
    print(f"   –ü–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤: {doc_md.content[:50]}...")
except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ MD: {e}")

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É PY —Ñ–∞–π–ª–∞
try:
    doc_py = loader.load_file(str(py_file))
    print(f"üìÑ PY —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω:")
    print(f"   –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {len(doc_py.content)} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"   –ò–º—è —Ñ–∞–π–ª–∞: {doc_py.metadata['filename']}")
    print(f"   –ü–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤: {doc_py.content[:50]}...")
except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ PY: {e}")

print("\nüìÅ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏...")

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤—Å–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
try:
    documents = loader.load_directory(str(test_dir))
    print(f"üìÅ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {len(documents)}")
    
    for i, doc in enumerate(documents, 1):
        print(f"   {i}. {doc.metadata['filename']} ({doc.metadata['file_extension']}) - {len(doc.content)} —Å–∏–º–≤–æ–ª–æ–≤")
        
except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {e}")

print("\nüåê –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É URL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)...")

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É URL (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)
try:
    # –ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è —Ç–µ—Å—Ç–∞
    url_doc = loader.load_url("https://httpbin.org/html")
    print(f"üåê URL –∑–∞–≥—Ä—É–∂–µ–Ω:")
    print(f"   –ó–∞–≥–æ–ª–æ–≤–æ–∫: {url_doc.metadata.get('title', '–ù–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞')}")
    print(f"   –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {len(url_doc.content)} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"   –ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤: {url_doc.content[:100]}...")
except ImportError as e:
    print(f"‚ö†Ô∏è –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ URL –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏: {e}")
except Exception as e:
    print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ URL (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞): {e}")

print("\n‚ùå –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫...")

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
try:
    loader.load_file("–Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π_—Ñ–∞–π–ª.txt")
except FileNotFoundError as e:
    print(f"‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –æ—à–∏–±–∫–∞: {e}")

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
try:
    loader.load_directory("–Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è_–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è")
except ValueError as e:
    print(f"‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –æ—à–∏–±–∫–∞: {e}")

print("\nüéâ –¢–µ—Å—Ç DocumentLoader –∑–∞–≤–µ—Ä—à–µ–Ω!")
print("\nüìö –ß—Ç–æ —É–º–µ–µ—Ç DocumentLoader:")
print("‚úÖ –ó–∞–≥—Ä—É–∂–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã (TXT, MD, PY, JS, HTML, CSS)")
print("‚úÖ –ó–∞–≥—Ä—É–∂–∞—Ç—å PDF —Ñ–∞–π–ª—ã (—Ç—Ä–µ–±—É–µ—Ç PyPDF2)")
print("‚úÖ –ó–∞–≥—Ä—É–∂–∞—Ç—å DOCX —Ñ–∞–π–ª—ã (—Ç—Ä–µ–±—É–µ—Ç python-docx)")
print("‚úÖ –ó–∞–≥—Ä—É–∂–∞—Ç—å –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Ç—Ä–µ–±—É–µ—Ç requests, beautifulsoup4)")
print("‚úÖ –ó–∞–≥—Ä—É–∂–∞—Ç—å —Ü–µ–ª—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π")
print("‚úÖ –ò–∑–≤–ª–µ–∫–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–æ–≤")
print("‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏")
print("‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏")